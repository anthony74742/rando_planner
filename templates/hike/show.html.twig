{% extends 'base.html.twig' %}

{% block title %}{{ hike.title }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {% if hike.gpxTrack %}
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    {% endif %}
{% endblock %}

{% block body %}
    <div class="min-h-screen bg-gray-50">
        {{ include('_nav.html.twig') }}

        <div class="max-w-5xl mx-auto px-4 py-8">
            {# Bouton retour #}
            <div class="mb-6">
                <a href="{{ path('app_home') }}" class="inline-flex items-center text-gray-600 hover:text-green-600 transition">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Retour
                </a>
            </div>

            {# Messages flash #}
            {% for message in app.flashes('success') %}
                <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-6">
                    {{ message }}
                </div>
            {% endfor %}

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {# Colonne principale #}
                <div class="lg:col-span-2 space-y-6">
                    {# Image et titre #}
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <div class="w-full h-96 bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center">
                            <span class="text-white text-8xl">ü•æ</span>
                        </div>

                        <div class="p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex-1">
                                    <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ hike.title }}</h1>
                                    <div class="flex items-center gap-3 text-sm text-gray-500">
                                        <span>Cr√©√© le {{ hike.createdAt|date('d/m/Y') }}</span>
                                        {% if not hike.isPublic %}
                                            <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs">Priv√©</span>
                                        {% endif %}
                                    </div>
                                </div>

                                {% if app.user and app.user == hike.creator %}
                                    <div class="flex gap-2">
                                        <a href="{{ path('app_hike_edit', {'id': hike.id}) }}" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition">
                                            Modifier
                                        </a>
                                    </div>
                                {% endif %}
                            </div>

                            {# Description #}
                            {% if hike.description %}
                                <div class="prose max-w-none">
                                    <p class="text-gray-700 leading-relaxed">{{ hike.description }}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    {# Informations d√©taill√©es #}
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">D√©tails de la randonn√©e</h2>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="flex items-start gap-3">
                                <span class="text-2xl">üìç</span>
                                <div>
                                    <div class="text-sm text-gray-500">Lieu</div>
                                    <div class="font-medium text-gray-900">{{ hike.location }}</div>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="text-2xl">üìè</span>
                                <div>
                                    <div class="text-sm text-gray-500">Distance</div>
                                    <div class="font-medium text-gray-900">{{ hike.distance }} km</div>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <span class="text-2xl">‚è±Ô∏è</span>
                                <div>
                                    <div class="text-sm text-gray-500">Dur√©e</div>
                                    <div class="font-medium text-gray-900">{{ hike.duration }}</div>
                                </div>
                            </div>

                            {% if hike.difficulty %}
                                <div class="flex items-start gap-3">
                                    <span class="text-2xl">‚õ∞Ô∏è</span>
                                    <div>
                                        <div class="text-sm text-gray-500">Difficult√©</div>
                                        <div class="font-medium text-gray-900 capitalize">{{ hike.difficulty }}</div>
                                    </div>
                                </div>
                            {% endif %}

                            {% if hike.latitude and hike.longitude %}
                                <div class="flex items-start gap-3 col-span-2">
                                    <span class="text-2xl">üó∫Ô∏è</span>
                                    <div>
                                        <div class="text-sm text-gray-500">Coordonn√©es GPS</div>
                                        <div class="font-medium text-gray-900">{{ hike.latitude }}, {{ hike.longitude }}</div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if hike.gpxTrack %}
                        <div class="bg-white rounded-lg shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-xl font-semibold text-gray-900">Carte de l'itin√©raire</h2>
                                {% if hike.gpxFilename %}
                                    <a href="{{ asset('uploads/gpx/' ~ hike.gpxFilename) }}" download class="inline-flex items-center text-sm font-semibold text-green-600 hover:text-green-700">
                                        T√©l√©charger le GPX
                                    </a>
                                {% endif %}
                            </div>
                            <div
                                id="hike-map"
                                class="w-full h-96 rounded-xl border border-gray-200"
                                data-track="{{ hike.gpxTrack|json_encode|e('html_attr') }}">
                            </div>
                            <p class="text-xs text-gray-500 mt-3">Trace affich√©e √† partir du fichier GPX fourni.</p>
                        </div>
                    {% endif %}

                    {# Sessions #}
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-gray-900">Sessions organis√©es</h2>
                            {% if app.user %}
                                <a href="{{ path('app_session_new', {'hikeId': hike.id}) }}" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition">
                                    Cr√©er une session
                                </a>
                            {% endif %}
                        </div>

                        {% if hike.hikeSessions|length > 0 %}
                            <div class="space-y-3">
                                {% for session in hike.hikeSessions %}
                                    <div class="border border-gray-200 rounded-lg p-4 hover:border-green-300 transition">
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-3 mb-2">
                                                    <span class="text-lg">üìÖ</span>
                                                    <span class="font-medium text-gray-900">{{ session.date|date('d/m/Y √† H:i') }}</span>
                                                </div>
                                                <div class="flex items-center gap-4 text-sm text-gray-600">
                                                    <span>Organis√© par {{ session.creator.email }}</span>
                                                </div>
                                            </div>
                                            <a href="{{ path('app_hike_session_show', {'id': session.id}) }}" class="px-3 py-1 text-green-600 hover:bg-green-50 rounded transition text-sm font-medium">
                                                Voir
                                            </a>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-8">
                                <div class="text-4xl mb-3">üìÖ</div>
                                <p class="text-gray-500 mb-4">Aucune session pr√©vue pour cette randonn√©e</p>
                                {% if app.user %}
                                    <a href="{{ path('app_session_new', {'hikeId': hike.id}) }}" class="inline-block px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition">
                                        Organiser la premi√®re session
                                    </a>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                {# Sidebar #}
                <div class="space-y-6">
                    {# Cr√©ateur #}
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Cr√©√© par</h3>
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <span class="text-green-600 font-bold text-xl">{{ hike.creator.email|first|upper }}</span>
                            </div>
                            <div>
                                <div class="font-medium text-gray-900">{{ hike.creator.email }}</div>
                                <div class="text-sm text-gray-500">{{ hike.creator.creator|length }} randonn√©e(s)</div>
                            </div>
                        </div>
                    </div>

                    {# Actions rapides #}
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Actions</h3>
                        <div class="space-y-2">
                            {% if app.user %}
                                {% if app.user == hike.creator %}
                                    <a href="{{ path('app_hike_edit', {'id': hike.id}) }}" class="block w-full px-4 py-2 bg-green-600 text-white text-center text-sm font-medium rounded-lg hover:bg-green-700 transition">
                                        Modifier la randonn√©e
                                    </a>
                                    <form method="post" action="{{ path('app_hike_delete', {'id': hike.id}) }}" onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer cette randonn√©e ?');">
                                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ hike.id) }}">
                                        <button type="submit" class="block w-full px-4 py-2 bg-red-600 text-white text-center text-sm font-medium rounded-lg hover:bg-red-700 transition">
                                            Supprimer
                                        </button>
                                    </form>
                                {% else %}
                                    <a href="{{ path('app_session_new', {'hikeId': hike.id}) }}" class="block w-full px-4 py-2 bg-green-600 text-white text-center text-sm font-medium rounded-lg hover:bg-green-700 transition">
                                        Organiser une session
                                    </a>
                                {% endif %}
                            {% else %}
                                <a href="{{ path('app_register') }}" class="block w-full px-4 py-2 bg-green-600 text-white text-center text-sm font-medium rounded-lg hover:bg-green-700 transition">
                                    S'inscrire pour participer
                                </a>
                            {% endif %}
                        </div>
                    </div>

                    {# Statistiques #}
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Statistiques</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Sessions</span>
                                <span class="font-semibold text-gray-900">{{ hike.hikeSessions|length }}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Visibilit√©</span>
                                <span class="font-semibold text-gray-900">{{ hike.isPublic ? 'Public' : 'Priv√©' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {% if hike.gpxTrack %}
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const container = document.getElementById('hike-map');
                if (!container || !container.dataset.track) {
                    return;
                }

                let track = [];
                try {
                    track = JSON.parse(container.dataset.track) || [];
                } catch (error) {
                    console.error('Erreur lors de la lecture de la trace GPX', error);
                }

                if (!track.length) {
                    container.innerHTML = '<p class="text-sm text-gray-500 p-4">Trace GPX indisponible.</p>';
                    return;
                }

                const latlngs = track.map(point => [point.lat, point.lng]);
                const map = L.map(container).setView(latlngs[0], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);

                const route = L.polyline(latlngs, { color: '#16a34a', weight: 4, opacity: 0.9 }).addTo(map);
                map.fitBounds(route.getBounds(), { padding: [24, 24] });

                L.marker(latlngs[0], { title: 'D√©part' }).addTo(map);
                if (latlngs.length > 1) {
                    L.marker(latlngs[latlngs.length - 1], { title: 'Arriv√©e' }).addTo(map);
                }
            });
        </script>
    {% endif %}
{% endblock %}
